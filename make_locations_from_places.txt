
CREATE TABLE places (city VARCHAR(1024), state VARCHAR(256), county VARCHAR(256), lat REAL, lon REAL);
COPY places FROM '/Users/ben/chartio/datasets/ufo/scrapes/places.csv' DELIMITER ',' CSV;DELETE FROM places WHERE county is null;
DELETE FROM places WHERE city is null;
DELETE FROM places WHERE state not in ('AK', 'AL', 'AR', 'AZ', 'CA', 'CO', 'CT', 'DC', 'DE', 'FL', 'GA', 'HI', 'IA', 'ID', 'IL', 'IN', 'KS', 'KY', 'LA', 'MA', 'MD', 'ME', 'MI', 'MN', 'MO', 'MS', 'MT', 'NC', 'ND', 'NE', 'NH', 'NJ', 'NM', 'NV', 'NY', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC', 'SD', 'TN', 'TX', 'UT', 'VA', 'VT', 'WA', 'WI', 'WV', 'WY');
ALTER table places add column state_id INT, add column county_id INT, add column city_id INT;
CREATE TABLE states (id serial PRIMARY KEY, code VARCHAR(2), name VARCHAR(64), lat REAL, lon REAL);
CREATE TABLE counties (id serial PRIMARY KEY, name VARCHAR(256), state_id INT, lat REAL, lon REAL);
CREATE TABLE cities (id serial PRIMARY KEY, name VARCHAR(1024), state_id INT, county_id INT, lat REAL, lon REAL);
INSERT into states (code) SELECT distinct(state) FROM places ORDER BY state ASC;
INSERT into counties (name, state_id) SELECT p.county, s.id FROM places p join states s on p.state = s.code GROUP BY s.id, p.county;
UPDATE places SET state_id = (SELECT id FROM states WHERE states.code = places.state);
UPDATE places SET county_id = (SELECT id FROM counties WHERE counties.name = places.county and counties.state_id = places.state_id);
INSERT into cities (name, county_id, state_id, lat, lon) SELECT city, county_id, state_id, avg(lat), avg(lon) FROM places GROUP BY city, county_id, state_id;
UPDATE counties SET lat = (SELECT avg(lat) FROM places WHERE county_id = counties.id GROUP BY county_id);
UPDATE counties SET lon = (SELECT avg(lon) FROM places WHERE county_id = counties.id GROUP BY county_id);
UPDATE states SET lon = (SELECT avg(lon) FROM places WHERE state_id = states.id GROUP BY state_id);
UPDATE states SET lat = (SELECT avg(lat) FROM places WHERE state_id = states.id GROUP BY state_id);

CREATE TABLE doubles (id int, name VARCHAR(1024), state_id INT, county_id INT, county_name varchar(256), lat REAL, lon REAL);WITH duplicates AS (select name, state_id, count(*) from cities group by name, state_id HAVING count(*) > 1)
INSERT INTO doubles (id, name, state_id, county_id, lat, lon)
SELECT c.id, c.name, c.state_id, c.county_id, c.lat, c.lon FROM cities c
JOIN duplicates d ON c.name = d.name AND c.state_id = d.state_id;UPDATE doubles SET county_name = (select name from counties where counties.id = doubles.county_id);
CREATE TABLE city_counties (id int, city_name varchar(256), county_name varchar(256));
INSERT INTO city_counties (id, city_name, county_name) select id, name, county_name from doubles where name = county_name;
DELETE FROM doubles WHERE id in (select id from city_counties);DELETE FROM cities WHERE id in (select id from doubles);
DELETE FROM doubles WHERE name in (select city_name from city_counties);
INSERT INTO cities (name, state_id, county_id, lat, lon) SELECT name, state_id, MAX(county_id), AVG(lat), AVG(lon) FROM doubles GROUP BY name, state_id;
DROP TABLE city_counties;
DROP TABLE doubles;
DROP TABLE places;
COPY cities TO '/Users/ben/chartio/datasets/ufo/scrapes/cities.csv' DELIMITER',' CSV;
COPY states TO '/Users/ben/chartio/datasets/ufo/scrapes/states.csv' DELIMITER ',' CSV;
COPY counties TO '/Users/ben/chartio/datasets/ufo/scrapes/counties.csv' DELIMITER ',' CSV;
